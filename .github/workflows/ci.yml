name: CI Build and Test

on:
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

env:
  BUILD_TYPE: Debug

jobs:
  # Job 1: Code Quality Checks (runs first, fastest feedback)
  code-quality:
    runs-on: self-hosted
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
        
    - name: Check Code Quality
      run: |
        echo "Running code quality checks..."
        
        # Check for common issues
        echo "Checking for TODO/FIXME comments:"
        grep -r "TODO\|FIXME" src/ include/ || echo "No TODO/FIXME found"
        
        # Check for trailing whitespace
        echo "Checking for trailing whitespace:"
        if grep -r " $" src/ include/ *.md Makefile; then
          echo "✗ Found trailing whitespace"
          exit 1
        else
          echo "✓ No trailing whitespace found"
        fi
        
        # Check for tabs vs spaces consistency
        echo "Checking indentation consistency:"
        if find src/ include/ -name "*.c" -o -name "*.h" | xargs grep -l $'\t'; then
          echo "✗ Found mixed tabs/spaces"
          exit 1
        else
          echo "✓ Consistent indentation"
        fi

  # Job 2: Build Kernel and Dependencies
  build:
    runs-on: self-hosted
    needs: code-quality  # Wait for code quality to pass
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Check Dependencies
      run: |
        echo "Checking build dependencies..."
        
        # Check required tools
        echo "Checking for required build tools:"
        
        if command -v gcc >/dev/null 2>&1; then
          echo "✅ GCC: $(gcc --version | head -n1)"
        else
          echo "❌ GCC not found"
        fi
        
        if command -v nasm >/dev/null 2>&1; then
          echo "✅ NASM: $(nasm --version)"
        else
          echo "❌ NASM not found"
        fi
        
        if command -v grub-mkrescue >/dev/null 2>&1; then
          echo "✅ GRUB tools available"
        else
          echo "⚠️  GRUB tools not found (ISO creation may fail)"
        fi
        
        if command -v xorriso >/dev/null 2>&1; then
          echo "✅ Xorriso available"
        else
          echo "⚠️  Xorriso not found (ISO creation may fail)"
        fi
        
        if command -v qemu-system-i386 >/dev/null 2>&1; then
          echo "✅ QEMU: $(qemu-system-i386 --version | head -n1)"
        else
          echo "⚠️  QEMU not found (boot testing may fail)"
        fi
        
        # Check if core build tools are available
        if ! command -v gcc >/dev/null 2>&1 || ! command -v nasm >/dev/null 2>&1; then
          echo ""
          echo "❌ Essential build tools missing!"
          echo "Please install dependencies on your runner:"
          echo "sudo apt update && sudo apt install -y build-essential nasm grub-pc-bin grub-common xorriso qemu-system-x86"
          exit 1
        fi
        
        echo ""
        echo "✅ Core build dependencies satisfied"
        
    - name: Get Version Information
      id: version
      run: |
        MAJOR=$(grep "VERSION_MAJOR = " Makefile | cut -d' ' -f3 | tr -d '\r\n' | tr -d ' ')
        MINOR=$(grep "VERSION_MINOR = " Makefile | cut -d' ' -f3 | tr -d '\r\n' | tr -d ' ')
        PATCH=$(grep "VERSION_PATCH = " Makefile | cut -d' ' -f3 | tr -d '\r\n' | tr -d ' ')
        VERSION="${MAJOR}.${MINOR}.${PATCH}"
        # Clean version string of any special characters
        VERSION=$(echo "$VERSION" | tr -d '\r\n\t ' | sed 's/[^0-9.]//g')
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Building LevelOS v${VERSION}"
        
    - name: Clean Build Environment
      run: |
        echo "Cleaning previous build..."
        make clean
        
    - name: Build Library Components
      run: |
        echo "Building library components..."
        make lib
        echo "Library build completed"
        
    - name: Build Kernel
      run: |
        echo "Building LevelOS kernel..."
        if make; then
          echo "Kernel build completed successfully"
          
          # Verify the kernel was actually created
          if [ -f build/level-os-*.bin ]; then
            echo "✅ Kernel binary created: $(ls build/level-os-*.bin)"
            ls -la build/level-os-*.bin
          else
            echo "❌ Kernel binary not found after build!"
            echo "Build directory contents:"
            ls -la build/
            exit 1
          fi
        else
          echo "❌ Kernel build failed!"
          exit 1
        fi
        
    - name: Verify Build Artifacts
      run: |
        echo "Verifying build artifacts before upload..."
        
        # Wait a moment for any lingering processes
        sleep 2
        
        echo "Build directory contents:"
        ls -la build/
        
        echo "Looking for kernel binary:"
        if ls build/level-os-*.bin 1> /dev/null 2>&1; then
          echo "✅ Found kernel binary:"
          ls -la build/level-os-*.bin
        else
          echo "❌ No kernel binary found!"
          echo "Available files in build/:"
          find build/ -type f | head -10
          exit 1
        fi
        
        echo "Checking build directory structure:"
        find build/ -type f | head -10
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: levelos-build-${{ steps.version.outputs.version }}
        path: |
          build/
        retention-days: 7

  # Job 3: Create Bootable ISO
  create-iso:
    runs-on: self-hosted
    needs: build  # Wait for build to complete
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: levelos-build-${{ needs.build.outputs.version }}
        path: build/
        
    - name: Fix File Permissions
      run: |
        echo "Fixing file permissions..."
        chmod +x build/level-os-*.bin || echo "No binary files to fix"
        ls -la build/
        
    - name: Create Bootable ISO
      run: |
        echo "Creating bootable ISO..."
        
        # Check if GRUB tools are available
        if command -v grub-mkrescue >/dev/null 2>&1 && command -v xorriso >/dev/null 2>&1; then
          echo "GRUB tools available, creating ISO..."
          if make iso; then
            echo "✅ ISO creation successful"
          else
            echo "❌ ISO creation failed"
          fi
        else
          echo "⚠️  GRUB tools not available, skipping ISO creation"
          echo "To enable ISO creation, install: sudo apt install grub-pc-bin grub-common xorriso"
        fi
        
        # List what was actually created
        echo "Build directory contents:"
        ls -la build/ || echo "Build directory listing failed"
        
    - name: Verify Multiboot Compliance
      run: |
        echo "Verifying multiboot compliance:"
        grub-file --is-x86-multiboot build/level-os-*.bin && echo "✓ Multiboot compliant" || echo "✗ Multiboot check failed"
        
    - name: Upload ISO Artifact
      uses: actions/upload-artifact@v4
      with:
        name: levelos-iso-${{ needs.build.outputs.version }}
        path: build/level-os-*.iso
        retention-days: 7

  # Job 4: Run Tests
  test:
    runs-on: self-hosted
    needs: build  # Can run in parallel with create-iso
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: levelos-build-${{ needs.build.outputs.version }}
        path: build/
        
    - name: Run Unit Tests
      run: |
        echo "Running test suite..."
        make test || echo "Tests completed with warnings"
        
    - name: Test Kernel Boot (QEMU)
      run: |
        echo "Testing kernel boot in QEMU (headless)..."
        
        # Check if QEMU is available
        if command -v qemu-system-i386 >/dev/null 2>&1; then
          echo "QEMU available, running boot test..."
          # Run QEMU with timeout and capture output
          timeout 10s qemu-system-i386 -kernel build/level-os-*.bin -nographic -serial stdio -display none 2>&1 || echo "Boot test completed"
          echo "✅ QEMU boot test finished"
        else
          echo "⚠️  QEMU not available, skipping boot test"
          echo "To enable boot testing, install: sudo apt install qemu-system-x86"
        fi

  # Job 5: Verification and Summary
  verify:
    runs-on: self-hosted
    needs: [build, create-iso, test]  # Wait for all build jobs
    if: always()  # Run even if previous jobs fail
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
        
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      
    - name: Verify Build Artifacts
      run: |
        echo "Verifying build artifacts..."
        make info
        
        # Check if kernel binary exists
        if [ -f "levelos-build-"*/level-os-*.bin ] || [ -f "build/level-os-"*.bin ]; then
          echo "✓ Kernel binary created"
        else
          echo "✗ Kernel binary missing"
          echo "Available files:"
          find . -name "*.bin" 2>/dev/null || echo "No .bin files found"
          ls -la levelos-build-*/ 2>/dev/null || echo "No build artifacts directory"
          exit 1
        fi
        
        # Check if ISO exists (don't fail if missing, just report)
        if [ -f "levelos-iso-"*/level-os-*.iso ] || [ -f "build/level-os-"*.iso ]; then
          echo "✓ ISO image created"  
        else
          echo "⚠ ISO image missing (this may be expected if ISO creation failed)"
        fi
        
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up CI build..."
        make clean
        rm -rf levelos-*
        
    - name: CI Summary
      if: always()
      run: |
        echo "=========================="
        echo "LevelOS CI Summary"  
        echo "=========================="
        echo "PR: #${{ github.event.number }}"
        echo "Build Status: ${{ needs.build.result }}"
        echo "Test Status: ${{ needs.test.result }}"
        echo "ISO Status: ${{ needs.create-iso.result }}"
        echo "Commit: ${{ github.sha }}"
        
        # Consider build successful if build and tests pass (ISO is optional)
        if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ]; then
          echo "✓ Core functionality working - ready for merge!"
          if [ "${{ needs.create-iso.result }}" != "success" ]; then
            echo "⚠ Note: ISO creation had issues but this doesn't block the merge"
          fi
        else
          echo "✗ CI failed - please fix issues before merging"
          exit 1
        fi
